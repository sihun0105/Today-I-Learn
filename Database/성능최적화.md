### 성능최적화

성능 최적화에 있어 MySQL 성능에서 핵심 지표인 쿼리 응답 시간 향상에 집중해야 한다. 하드웨어 문제로 돌리면 안됩니다. MySQL이 시작되면 먼저 쿼리 메트릭으로 MySQL이 수행하는 작업을 확인한 다음 느린 쿼리를 분석하고 최적화하여 응답 시간을 단축해야 한다.

MySQL은 보통 테이블당 하나의 인덱스만 사용한다고 하지만 꼭 그렇지는 않다. 인덱스의 병합 최적화에서는 2개의 인덱스를 사용할 수 있다.

#### 직접쿼리 최적화

직접 쿼리 최적화는 쿼리와 인덱스를 변경하는 것이다. 이러한 변경으로 성능 문제를 상다히 해결할 수 있다.

##### SELECT 문 최적화하기

- 범위 최적화
- 인덱스 머지 최적화
- 해쉬조인 최적화
- 인덱스 컨디션 푸시다운 최적화
- 다중 범위 읽기 최적화
- Constant-Folding 최적화
- IS NULL 최적화
- ORDER BY 최적화
- GROUP BY 최적화
- DISTINCT 최적화
- LIMIT 최적화
  https://dev.mysql.com/doc/refman/8.0/en/select-optimization.html

#### 쿼리 메트릭

쿼리 메트릭은 응답 시간, 잠금 시간, 조회된 행 등 쿼리 실행에 관하여 중요한 통찰력을 제공한다. 그러나 쿼리 메트릭은 다른 메트릭과 마찬가지로 엔지니어에게 의미 있는 방식으로 수집, 집계, 보고해야 하는 원시 값이다.
쿼리 메트릭은 쿼리별로 그룹화되고 집계된다. 쿼리 응답 시간은 MySQL 성능에서 핵심 지표이므로 쿼리별로 쿼리 메트릭을 그룹화하는 것이 응답시간이 가장 느린 쿼리를 확인하는 최선의 방법이다.쿼리를 고유하게 식별하는 방법으로는 정규화된 SQL문을 SHA-256 해시로 변환하여 쿼리가 속한 그룹을 결정한다.

> 정규화된 텍스트 : `SELECT 'col' FROM 'tbl' WHERE 'id' = ?` > _SQL 정규화는 모든 값을 ?로 바꾸고 여러 공백을 단일 공배그올 축소한다_

MySQL 성능을 높이려면 쿼리를 최적화해야 하며, 쿼리를 최적화하려면 쿼리 실행 방식을 이해해야 한다. 그리고 이를 이해하려면 쿼리 보고서와 메타데이터 등 관련 정보를 사용하여 분석해야 한다.

- 슬로 쿼리 로그 : 디스크에 있는 로그파일

- 성능 스키마(Perfomance_schema) : `Perfomance_schema`란 이름의 데이터베이스이다.

슬로쿼리로그와 성능 스키마의 본질적으로 완전히 다르지만, 둘 다 쿼리 메트릭을 제공한다. 주요 차이점은 얼마나 많은 메트릭을 제공하는지이다. 둘 다 쿼리 응답시간을 제외하고 3~20개 이상의 메트릭을 제공한다.

#### 잠금(Lock)

잠금(Lock)이란?
여러 세션(트랜잭션)이 동시에 동일한 레코드나 테이블을 읽거나 수정할 경우 순서대로 한 시점에 하나의 세선(트랜잭션)만 변경할 수 있도록 해주는 역할을 한다.
잠금은 트랜잭션과 비슷한 개념같지만, 잠금은 동시성제어를 하기 위한 기능이고, 트랜잭션은 데이터의 정합성을 보장하기 위한 기능이다.

##### SELECT

SELECT에는 `비잠금 읽기`와 `잠금 읽기`가 있다.

- > SELECT ... FOR UPDATE // LOCK을 흭득하고 세션이 UPDATE 쿼리 후 COMMIT 전까지 상호배제 상태가 된다.
- > SELECT ... FOR SHARE // 다른 세션에서 SELECT는 가능하지만, UPDATE에 대해서 잠금(Shared Lock)을 한다.

##### MySQL 엔진의 잠금

MySQL에서의 잠금은 스토리지 엔진 레벨과, MySQL 엔진 레벨로 나눌 수 있다.

> `MySQL 엔진 레벨` : MySQL 엔진 레벨의 잠금은 모든 스토리지 엔진에 영향을 미친다.

> `스토리지 엔진 레벨의 잠금` : 스토리지 엔진 레벨의 잠금은 스토리지 엔진 간 상호 영향을 미치지는 않는다.

InnoDB 스토리지 엔진에서 잠금에는 `테이블락`과 `로우락`이 존재한다. mysql은 테이블과 테이블락을 관리한다. 스토리지 엔진으로 테이블이 생성되지만, 스토리이 엔진에 구애받지 않는다. 즉 테이블을 현재 스토리지 엔진에서 다른 스토리지 엔진으로 변환할 수 있다.

#### 간접쿼리 최적화

간접쿼리 최적화는 데이터와 접근 패턴을 변경하는 것이다. 쿼리 변경 대신 쿼리가 접근하는 대상과 방법을 변경한다. 쿼리, 데이터, 접근패턴은 성능과 관련하여 뗄 수 없는 관계이므로 이러한 변경은 쿼리를 간접적으로 최적화해 준다.

#### 느린쿼리 식별

슬로 쿼리 로그를 활성화 하는 방법은 간단하다. SUPER 권한이 있는 계정으로 접속하여 다음 sql을 실행한다.

```
SET GLOBAL long_query_time=0;
SET GLOBAL slow_query_loh=ON;
SELECT @@GLOBAL.slow_query_log_file;
-------------------------------------
@@GLOBAL.slow_query_log_file
/usr/local/var/mysql/slow.log
```
